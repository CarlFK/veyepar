{# episode.html #}
{% extends "base.html" %}

{% block head %}
<link href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" rel="stylesheet">
<script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
<script src="http://formstone.it/components/Zoomer/jquery.fs.zoomer.js"></script>
<link href="http://formstone.it/components/Zoomer/jquery.fs.zoomer.css" rel="stylesheet">
<link href="{{STATIC_URL}}css/hideme.css" rel="stylesheet">
<title>veyepar: {{episode.name}}</title>
{% endblock %}

{% block content %}

--client <a href="{% url "client" client.slug %}">{{ client.slug }}</a>
--show <a href="{% url "episode_list" client.slug show.slug%}">{{ show.slug }}</a> {{episode.id}} --force
<br/>

{% if prev_episode %}
  <a href="/main/E/{{ prev_episode.id }}">Prev: {{prev_episode.state }} {{prev_episode.name }}</a>
{% else %}
  Prev: (none, at start of list)
{% endif %}
<br/>
{% if next_episode %}
<a href="/main/E/{{ next_episode.id }}">Next: {{next_episode.state }} {{next_episode.name }}</a>
{% else %}
  Next: (none, at end of list)
{% endif %}

<table>
<tbody>
<tr><td>Name</td><td><b>{{episode.name}}</b></td></tr>
<tr><td>Author(s)</td><td>{{episode.authors}} </td></tr>
<tr><td>Location</td><td><a href="{% url "admin:main_location_change" location.id%}">{{episode.location}}</a></td><td>{{episode.location.channelcopy}}</td>
</tr>
<tr><td>Date</td><td><a href="{% url "episode_list" client_slug=client.slug show_slug=show.slug %}?client={{client.slug}}&amp;show={{show.slug}}&amp;location_slug={{episode.location.slug}}&amp;date={{episode.start|date:"Y-m-d"}}">
            {{episode.start|date:"b D d"}}</a></td>
    <td> <a href="{% url "rf_set" episode.location.slug %}?start_date={{episode.start|date:"Y-m-d"}}">Days Raw Files</a> </td>
</tr>

<tr><td>Start</td><td>{% if same_dates %}{{episode.start|date:"H:i"}}{% else %}{{episode.start}}{% endif %}</td>
<td>First Raw Start</td><td>{% if same_dates %}{{clrffs.0.0.raw_file.start|date:"H:i"}}{% else %}{{clrffs.0.0.raw_file.start}}{% endif %}</td></tr>
<tr>
<td>Duration</td><td>{{episode.duration}}</td>
<td>Offset</td><td>{{offset}}</td>

</tr>
<tr><td>End</td><td> {% if same_dates %}{{episode.end|date:"H:i"}}{% else %}{{episode.end}}{% endif %} </td>
<td>Last Raw End</td> {% with clrffs|last as last_clrffs %}{% with last_clrffs.0.raw_file.end as end %} <td>{% if same_dates %} {{end|date:"H:i"}} {% else %} {{end}} {% endif %}</td> {% endwith %} {% endwith %}
</tr>
<tr>
    <td><a href="{% url "episode_chaps" episode.id %}">Chapters</a></td> <td>
        {% for chap in chaps %}
          {% if chap.0 %}
            <a href="#{{chap.2.id}}" style="display: inline-block;">{{chap.0.1}}</a>
          {%endif%}
        {%endfor%}
    </td>
</tr>
<tr>
    <td>Total cuts_time</td><td>{{ episode.cuts_time }}</td>
</tr>

</tbody>
</table>

{% if episode.conf_url %}
  <a href="{{episode.conf_url}}">{{episode.conf_url}}</a><br/>
{% endif %}

{% if episode.edit_key and user.is_authenticated %}
   <a href="{% url "guest_episode_review" show_slug=episode.show.slug episode_slug=episode.slug edit_key=episode.edit_key %}">Simple UI</a>
   <a href="{% url "train" episode.id episode.slug episode.edit_key %}">train</a>
   <a href="{% url "approve_episode" episode.id episode.slug episode.edit_key %}">approve</a>
   <br/>
{% endif %}

{% if episode.public_url %}
  {% if episode.show.slug == "fosdem_2014" %}
    <img src ="http://964bdd2f965bbc4ca8f5-3ebaa0e988d98119a4fead51a26da83a.r42.cf2.rackcdn.com/veyepar/{{episode.show.client.slug}}/{{episode.show.slug}}/webm/{{episode.slug}}_audio.png" alt="final audio">
  {% else %}
    <img src ="{{MEDIA_URL}}{{episode.show.client.slug}}/{{episode.show.slug}}/webm/{{episode.slug}}_audio.png" alt="final audio">
  {% endif %}
   <br/>
{% endif %}

<a href="{% url "raw_list" episode.id %}{{episode.slug}}.m3u">raw-playlist</a>
<a href="{% url "raw_list" episode.id %}{{episode.slug}}-ogv.m3u?ext=ogv">raw-ogv-playlist</a>

<a href="{% url "public_play_list" %}{{episode.slug}}.m3u?id={{episode.id}}">encoded-files-playlist</a> 

{% if episode.host_url %} <a href="{{episode.host_url}}">host</a>{%endif%}
{% if episode.public_url%}<a href="{{episode.public_url}}">public</a>{%endif%}
{% if episode.twitter_url%}<a href="{{episode.twitter_url}}">tweet</a>{%endif%}

<a href="{{MEDIA_URL}}{{client.slug}}/{{show.slug}}/titles/{{episode.slug}}.svg"> svg</a>
<a href="{{MEDIA_URL}}{{client.slug}}/{{show.slug}}/titles/{{episode.slug}}.png"> png</a><br/>

<a href="{{MEDIA_URL}}{{client.slug}}/{{show.slug}}/ogv/{{episode.slug}}.ogv">ogv</a>
<a href="{{MEDIA_URL}}{{client.slug}}/{{show.slug}}/mp4/{{episode.slug}}.mp4">mp4</a>
<a href="{{MEDIA_URL}}{{client.slug}}/{{show.slug}}/webm/{{episode.slug}}.webm">webm</a>

<a href="{% url "pdf" 'release_agreements' show.id episode.id %}{{episode.slug}}.pdf">release.pdf</a>

<a href="{% url "eps_xfer" episode.show.client.slug episode.show.slug %}?id={{episode.id}}">{{episode.slug}}.json</a>
<br/>
<a href="{% url "episode_logs" episode.id %}">logs</a><br/>

Admin: <a href="{% url "admin:main_episode_change" episode.id%}">episode</a>
<a href="{% url "admin:main_cut_list_changelist" %}?episode__id__exact={{episode.id}}">cut list</a>
<a href="{% url "admin:main_raw_file_changelist" %}?location__id__exact={{episode.location.id}}&amp;start__year={{episode.start|date:"Y"}}&amp;start__month={{episode.start|date:"m"}}&amp;start__day={{episode.start|date:"d"}}">raw files day</a>

{%if episode.host %}
<input type="checkbox" id="ep-sm" class="ep-showmore"> <label class="ep-summary" for="ep-sm">show player...</label>
    {%if episode.state == 4 %}
    {# embed player here #}
    {% endif %}
{% endif %}

{% for e in email_eps %}
  {{e.authors}} &lt;{{e.emails}}&gt;
  {{e.show.slug}}  {{e.name}} 
  <br/>
{% endfor %}

<form method="POST">{% csrf_token %}

<input type="checkbox" id="ep-sm" class="ep-showmore"> <label class="ep-summary" for="ep-sm">show more...</label>

<div class="ep-detail">
<table border=1 >
<tbody>
{{ episode_form }}
</tbody>
</table>
</div>

<input type="submit" value="{{user.is_authenticated|yesno:"Save,not logged in,"}}" />

<div id="sheets">
{% if episode.image_file_set.all %}
 <div class="viewer" style="height: 200px; width: 800px;" >
{% for img in episode.image_file_set.all %}
{% if episode.show.slug == "pyohio_2015" %}
    <img alt="recording sheet" src="http://64966d3674e0a64d8f4a-47c94b14ef8e1f83d5390cdb0629c6ed.r53.cf2.rackcdn.com/veyepar/{{client.slug}}/{{show.slug}}/img/{{img.filename}}" height=160 >
  {% else %}
    <img alt="recording sheet" src="{{MEDIA_URL}}{{client.slug}}/{{show.slug}}/img/{{img.filename}}" width=300 height=400 >
{% endif %}
{% endfor %}
 </div> <!-- class="viewer" -->
</div> <! -- id="sheets" --> 

 <script>
$(".viewer").zoomer();
 </script>
{% endif %}

{% comment %}
{% for img in episode.image_file_set.all %}
<a href="http://192.237.240.167/static/veyepar/{{client.slug}}/{{show.slug}}/img/{{img.filename}}">
    <img alt="recording sheet" src="http://192.237.240.167/static/veyepar/{{client.slug}}/{{show.slug}}/img/{{img.filename}}" width=90 >
</a>
{% endfor %}
{% endcomment %}


{{ clrfformset.management_form }}


{% for cl,chap,clrfform in clrffs %}

<div id="cl{{cl.id}}">

  {{cl.raw_file.filename}}
  {{ clrfform.apply }}{{ clrfform.apply.label_tag }}

  <u><b>S:</b> {{cl.raw_file.start|date:"H:i:s"}} - <b>E:</b> {{cl.raw_file.end|date:"H:i:s"}} <b>D:</b> {{cl.raw_file.duration}} </u>
          {% if clrfform.start.value %} (<b>Start:</b> {{ clrfform.start.value }}){% endif %} 
  {% if clrfform.end.value %} (<b>End:</b> {{ clrfform.end.value }}){% endif %} 

  <input type="checkbox" id="cl-{{forloop.counter0}}" class="cl-showmore"> <label class="cl-summary" for="cl-{{forloop.counter0}}">show more...</label>

  <div class="cl-detail">
      {{clrfform.clid}}

~/Videos/veyepar/{{cl.raw_file.base_url}}.dv 
      <table>
      <tr>
      <td>
       <video
          id="rawfile{{ cl.id }}"
          {% if episode.show.slug == "fosdem_2014" %}
              src="http://veyepar.cdn.nextdayvideo.com/veyepar/{{client.slug}}/{{show.slug}}/dv/{{location.slug}}/{{cl.raw_file.basename}}.ogv"
          {% elif episode.show.slug == "debconf14" %}
              src="http://veyepar.cdn.dc14.nextdayvideo.com/veyepar/{{client.slug}}/{{show.slug}}/dv/{{location.slug}}/{{cl.raw_file.basename}}.ogv"
          {% else %}
              src="{{MEDIA_URL}}{{client.slug}}/{{show.slug}}/dv/{{location.slug}}/{{cl.raw_file.basename}}.webm"
          {% endif %}
          controls
          preload="metadata"
          width=400
          {# poster="{{MEDIA_URL}}{{client.slug}}/{{show.slug}}/dv/{{location.slug}}/{{cl.raw_file.basename}}.png" #}
          ></video>
      </td>

      <td>
        <table>
            <tr>
                <td></td>
                <td><a href="{% url "admin:main_raw_file_change" cl.raw_file.id%}">Raw File</a></td>
                <td><a href="{% url "admin:main_cut_list_change" cl.id%}">Cut List</a></td>
            </tr>

            {# {{ clrfform.trash.label_tag }}{{ clrfform.trash }} #}

            <tr>
                <td><input type="button" id="go-start-{{cl.id}}" value="Start"> </td>
                <td><b>{% if same_dates %}{{cl.raw_file.start|date:"H:i:s"}}{% else %}{{cl.raw_file.start}}{% endif %}</b></td>
                <td>
                    <input type="button" value="&gt;" id="start{{cl.id}}">
                    {{ clrfform.start }}
                    <input type="button" id="grab-start-{{cl.id}}" value="grab">
                    {{chap.0}}
                </td>
            </tr>

            <tr>
                <td>Duration</td>
                <td>{{cl.raw_file.duration}}</td>
                <td>
                    <input type="button" value="-5s" id="back5-{{cl.id}}"> 
                    <input type="button" value="+5s" id="fwd5-{{cl.id}}"> 
                    <input type="button" value="end-5s" id="end5-{{cl.id}}"> 
                </td>
            </tr>

            <tr>
                <td><input type="button" id="go-end-{{cl.id}}" value="End"> </td>
                <td> {% if same_dates %}{{cl.raw_file.end|date:"H:i:s"}}{% else %}{{cl.raw_file.end}}{% endif %}</td>
                <td>
                    <input type="button" value="&gt;" id="end{{cl.id}}">
                    {{ clrfform.end }}
                    <input type="button" id="grab-end-{{cl.id}}" value="grab">
                    {{chap.1}}
                </td>
            </tr>

            <tr>
                <td>Comments:</td>
                <td>{# {{clrfform.rf_comment}} #}</td>
                <td>{{clrfform.cl_comment}}</td>
            </tr>

            <tr>
                <td>
                    {# <a href="{{MEDIA_URL}}{{client.slug}}/{{show.slug}}/dv/{{location.slug}}/{{cl.raw_file.filename}}">dv</a><br/> #}
                <a href="{{MEDIA_URL}}{{client.slug}}/{{show.slug}}/dv/{{location.slug}}/{{cl.raw_file.basename}}.ogv" target=ogv>ogv</a><br/>
                <a href="{% url "mk_play_list" %}?url={{MEDIA_URL}}{{client.slug}}/{{show.slug}}/dv/{{location.slug}}/{{cl.raw_file.basename}}.ogv">ogv.m3u</a>
  </td>
  <td>
                <a href="{% url "mk_play_list" %}?url={{MEDIA_URL}}{{client.slug}}/{{show.slug}}/dv/{{location.slug}}/{{cl.raw_file.basename}}.dv">dv.m3u</a>
                {#<a href="{{MEDIA_URL}}/{{client.slug}}/{{show.slug}}/dv/{{location.slug}}/{{cl.raw_file.basename}}.png">png</a> #}
      
                <td>
                    {{ clrfform.split.label_tag }}{{ clrfform.split }}
                    {{ clrfform.sequence.label_tag }}: {{ clrfform.sequence }}
                    <a href="{% url "admin:main_cut_list_change" cl.id%}delete/">delete</a>
                </td>
            </tr>
        </table>
      </td>
      </tr>
      </table>

  {% if clrfform.errors %}
  {% for field in clrfform %}
  {{field.name}}{{ field.errors }}
  {% endfor %}
  {% endif %}

  {% if cl.raw_file.ocrtext %}
  {{cl.raw_file.ocrtext|linebreaks}}
  {% endif %}

  {% if episode.show.slug == "fosdem_2014" %}
  <img id="audio_image_{{cl.id}}" alt="audio viz" 
    src ="http://964bdd2f965bbc4ca8f5-3ebaa0e988d98119a4fead51a26da83a.r42.cf2.rackcdn.com/veyepar/{{episode.show.client.slug}}/{{episode.show.slug}}/webm/{{episode.slug}}_audio.png">
{% else %}
  <img id="audio_image_{{cl.id}}" alt="audio viz" 
    src ="{{MEDIA_URL}}{{cl.raw_file.show.client.slug}}/{{cl.raw_file.show.slug}}/audio_png/dv/{{cl.raw_file.location.slug}}/{{cl.raw_file.basename}}_audio.png">
  {% endif %}

  {% with forloop.counter0 as x %}

    <script>

    var elementLeft{{x}} = $('#audio_image_{{cl.id}}').offset().left;
    var imageX{{x}} = 0;
    var vid{{x}} = $( "#rawfile{{cl.id}}" );
    var startbox{{x}} = $( "#{{clrfform.start.auto_id}}" );
    var endbox{{x}} = $( "#{{clrfform.end.auto_id}}" );

    $( "#audio_image_{{cl.id}}" ).mousemove(function( event ) {
        imageX{{x}} = (event.pageX - elementLeft{{x}});
       });

    $( "#audio_image_{{cl.id}}" ).click(function() {
        // seems I can't change .currentTime before something...
        // as long as the user hits play once, all is well.
        // saving/restoring state is too much hassle.
        // vid{{x}}[0].play();
        vid{{x}}[0].currentTime = imageX{{x}};
        // vid{{x}}[0].pause();
       });

    // move to start
    $( "#go-start-{{cl.id}}" ).click(function() {
            vid{{x}}[0].currentTime = 0;
       });

   // move to designated start
    $( "#start{{cl.id}}" ).click(function() {
            vid{{x}}[0].currentTime = startbox{{x}}.val();
       });

    // back 5 seconds 
    $( "#back5-{{cl.id}}" ).click(function() {
            vid{{x}}[0].currentTime = vid{{x}}.prop('currentTime')-5;
       });

    // fwd 5 seconds 
    $( "#fwd5-{{cl.id}}" ).click(function() {
            vid{{x}}[0].currentTime = vid{{x}}.prop('currentTime')+5;
       });

    // move to 5 sec before the end
    // (for "oh, it started!")
    $( "#end5-{{cl.id}}" ).click(function() {
        vid{{x}}[0].currentTime = {{cl.raw_file.get_seconds}}-5;
       });

    // move to designated end
    $( "#end{{cl.id}}" ).click(function() {
            vid{{x}}[0].currentTime = endbox{{x}}.val();
       });

    // startbox{{x}}.dblclick(function() {
    $( "#grab-start-{{cl.id}}" ).click(function() {
        startbox{{x}}.val(vid{{x}}.prop('currentTime')); });

    // endbox{{x}}.dblclick(function() {
    $( "#grab-end-{{cl.id}}" ).click(function() {
        endbox{{x}}.val(vid{{x}}.prop('currentTime')); });

    // move to end (why?  so no one askes why not.)
    $( "#go-end-{{cl.id}}" ).click(function() {
            vid{{x}}[0].currentTime = {{cl.raw_file.get_seconds}};
       });

    </script>

  {% endwith %}

  </div> <!-- class="cl-detail" -->
</div> <!-- id="{{cl.id}}" -->
{% endfor %}


<table border=1>
<tbody>
 {{ add_cutlist_to_ep }}
</tbody>
</table>

<input type="submit" value="Save">
</form>

{% for chap in chaps %}
  {% if chap.0 and chap.2.comment%}
  <p>({{chap.0.1}})  {{chap.2.comment}}</p>
  {%endif%}
{%endfor%}
 
{% endblock %}
